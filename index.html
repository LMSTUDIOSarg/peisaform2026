<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario PEISA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            padding: 20px;
        }
        
        .controls {
            max-width: 210mm;
            margin: 0 auto 20px auto;
            background: white;
            padding: 15px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .page-container {
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 10mm;
            position: relative;
        }
        
        #formContent {
            width: 100%;
        }
        
        /* Header */
        .header {
            display: table;
            width: 100%;
            margin-bottom: 3mm;
        }
        
        .logo-cell {
            display: table-cell;
            width: 40%;
            vertical-align: top;
        }
        
        .logo {
            font-size: 48px;
            font-weight: bold;
            color: #c00;
            letter-spacing: -2px;
            line-height: 1;
        }
        
        .logo-square {
            display: inline-block;
            width: 12px;
            height: 48px;
            background: #c00;
            margin-right: 2px;
            vertical-align: top;
        }
        
        .contact-cell {
            display: table-cell;
            text-align: right;
            vertical-align: top;
            font-size: 11px;
        }
        
        .contact-line {
            margin-bottom: 1px;
        }
        
        .contact-label {
            color: #c00;
            font-weight: bold;
        }
        
        /* Table structure */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0;
        }
        
        td, th {
            border: 2px solid #000;
            padding: 2mm 3mm;
            font-size: 11px;
            vertical-align: middle;
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow: hidden;
        }
        
        .red-header {
            background: #c00;
            color: white;
            font-weight: bold;
            padding: 1.5mm 3mm;
        }
        
        .label-cell {
            font-weight: bold;
            background: white;
            width: 20%;
        }
        
        .input-cell {
            background: white;
            min-height: 6mm;
        }
        
        /* Input fields */
        input[type="text"] {
            width: 100%;
            border: none;
            background: transparent;
            font-family: Arial, sans-serif;
            font-size: 11px;
            padding: 1mm 0;
            outline: none;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            line-height: 1.3;
        }
        
        input[type="text"]:focus {
            background: #fffde7;
        }
        
        /* Checkboxes */
        .checkbox-container {
            display: inline-flex;
            align-items: center;
            margin-right: 3mm;
        }
        
        input[type="checkbox"] {
            width: 4mm;
            height: 4mm;
            margin: 0 1mm 0 0;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .checkbox-label {
            font-weight: normal;
            font-size: 11px;
            white-space: nowrap;
        }
        
        /* Text areas for multi-line sections */
        .lined-area {
            width: 100%;
            min-height: 20mm;
            border: none;
            background: transparent;
            font-family: Arial, sans-serif;
            font-size: 11px;
            resize: none;
            outline: none;
            line-height: 5mm;
            padding: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .lined-area:focus {
            background: #fffde7;
        }
        
        /* Signature areas */
        .signature-canvas {
            border: 2px solid #000;
            cursor: crosshair;
            width: 100%;
            display: block;
            background: white;
            touch-action: none;
        }
        
        .signature-label {
            font-weight: bold;
            font-size: 10px;
            text-align: center;
            margin-top: 1mm;
        }
        
        .clear-btn {
            font-size: 9px;
            padding: 1mm 2mm;
            margin-top: 1mm;
            background: #ff9800;
            color: white;
            border: none;
            cursor: pointer;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        .clear-btn:hover {
            background: #f57c00;
        }
        
        /* Footer */
        .footer {
            background: #c00;
            color: white;
            padding: 2mm;
            font-size: 8px;
            line-height: 1.4;
            margin-top: 3mm;
        }
        
        /* Save button */
        .btn-save {
            background: #4CAF50;
            color: white;
            font-size: 16px;
            padding: 12px 30px;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .btn-save:hover {
            background: #45a049;
        }
        
        .btn-save:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Narrow columns for table */
        .col-num { width: 3%; }
        .col-cant { width: 6%; }
        .col-codigo { width: 10%; }
        .col-componente { width: 30%; }
        .col-defecto { width: 30%; }
        .col-check { width: 10%; text-align: center; }
        
        @media print {
            body { background: white; padding: 0; }
            .controls { display: none; }
            .page-container { box-shadow: none; margin: 0; }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div id="formContent">
            <!-- Draggable Image Container -->
            <div id="imageContainer" style="display: none; position: absolute; cursor: move; z-index: 1000; border: 2px solid #2196F3; background: white; padding: 5px;">
                <img id="uploadedImage" style="max-width: 300px; max-height: 200px; display: block;">
                <div style="text-align: center; margin-top: 5px;">
                    <button onclick="removeImage()" style="padding: 4px 8px; background: #f44336; color: white; border: none; cursor: pointer; border-radius: 3px; font-size: 10px; margin-right: 5px;">
                        üóëÔ∏è Eliminar
                    </button>
                    <button onclick="resizeImage('smaller')" style="padding: 4px 8px; background: #ff9800; color: white; border: none; cursor: pointer; border-radius: 3px; font-size: 10px; margin-right: 5px;">
                        ‚ûñ Reducir
                    </button>
                    <button onclick="resizeImage('larger')" style="padding: 4px 8px; background: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 3px; font-size: 10px;">
                        ‚ûï Agrandar
                    </button>
                </div>
            </div>

            <!-- Header -->
            <div class="header">
                <div class="logo-cell">
                    <div class="logo">
                        <span class="logo-square"></span>PEISA
                    </div>
                </div>
                <div class="contact-cell">
                    <div class="contact-line"><span class="contact-label">Servicio T√©cnico Oficial PEISA:</span> 0810-222-7378</div>
                    <div class="contact-line"><span class="contact-label">Formulario Web:</span> www.peisa.com.ar/service</div>
                </div>
            </div>

            <!-- SERVICE Section -->
            <table>
                <tr>
                    <td class="red-header" style="width: 15%;">SERVICE:</td>
                    <td style="width: 25%;">
                        <strong>Fecha service</strong>
                        <input type="text" placeholder="  /  /" style="width: 60px; display: inline-block;">
                    </td>
                    <td style="width: 25%;">
                        <strong>T√©cnico</strong>
                        <input type="text">
                    </td>
                    <td style="width: 35%;">
                        <strong>Condici√≥n</strong>
                        <span class="checkbox-container">
                            <input type="checkbox" id="enGtia">
                            <label class="checkbox-label" for="enGtia">En Gt√≠a</label>
                        </span>
                        <span class="checkbox-container">
                            <input type="checkbox" id="fueraGtia">
                            <label class="checkbox-label" for="fueraGtia">Fuera Gt√≠a</label>
                        </span>
                    </td>
                </tr>
            </table>

            <!-- DATOS CLIENTE Section -->
            <table>
                <tr>
                    <td class="red-header" rowspan="3" style="width: 15%; vertical-align: top;">DATOS<br>CLIENTE:</td>
                    <td class="label-cell" style="width: 15%;">Nombre</td>
                    <td class="input-cell" colspan="3"><input type="text"></td>
                </tr>
                <tr>
                    <td class="label-cell">Domicilio</td>
                    <td class="input-cell" colspan="3"><input type="text"></td>
                </tr>
                <tr>
                    <td class="label-cell">Email</td>
                    <td class="input-cell" style="width: 35%;"><input type="text"></td>
                    <td class="label-cell" style="width: 15%;">Tel√©fonos</td>
                    <td class="input-cell" style="width: 35%;"><input type="text"></td>
                </tr>
            </table>

            <!-- EQUIPO Section -->
            <table>
                <tr>
                    <td class="red-header" rowspan="4" style="width: 15%; vertical-align: top;">EQUIPO:</td>
                    <td class="label-cell" style="width: 10%;">Tipo</td>
                    <td class="input-cell" style="width: 35%;"><input type="text"></td>
                    <td class="label-cell" style="width: 10%;">Modelo</td>
                    <td class="input-cell" style="width: 30%;"><input type="text"></td>
                </tr>
                <tr>
                    <td class="label-cell"># Serie / Fecha Fab</td>
                    <td class="input-cell"><input type="text"></td>
                    <td class="label-cell">Fecha Compra</td>
                    <td class="input-cell"><input type="text"></td>
                </tr>
                <tr>
                    <td class="label-cell">Factura Compra</td>
                    <td class="input-cell"><input type="text"></td>
                    <td class="label-cell">Instalador</td>
                    <td class="input-cell"><input type="text"></td>
                </tr>
                <tr>
                    <td colspan="4" style="padding: 1mm 2mm;">
                        <span class="checkbox-container">
                            <input type="checkbox" id="tn">
                            <label class="checkbox-label" for="tn">TN</label>
                        </span>
                        <span class="checkbox-container">
                            <input type="checkbox" id="tf">
                            <label class="checkbox-label" for="tf">TF</label>
                        </span>
                        <span class="checkbox-container">
                            <input type="checkbox" id="gn">
                            <label class="checkbox-label" for="gn">GN</label>
                        </span>
                        <span class="checkbox-container">
                            <input type="checkbox" id="ge">
                            <label class="checkbox-label" for="ge">GE</label>
                        </span>
                        <span class="checkbox-container">
                            <input type="checkbox" id="ds">
                            <label class="checkbox-label" for="ds">DS</label>
                        </span>
                        <span class="checkbox-container">
                            <input type="checkbox" id="c">
                            <label class="checkbox-label" for="c">C</label>
                        </span>
                        <span class="checkbox-container">
                            <input type="checkbox" id="acs">
                            <label class="checkbox-label" for="acs">ACS</label>
                        </span>
                        <span class="checkbox-container">
                            <input type="checkbox" id="radiador">
                            <label class="checkbox-label" for="radiador">Radiador</label>
                        </span>
                        <span class="checkbox-container">
                            <input type="checkbox" id="pisoRad">
                            <label class="checkbox-label" for="pisoRad">Piso Rad</label>
                        </span>
                    </td>
                </tr>
            </table>

            <!-- MOTIVO DE LA SOLICITUD -->
            <table>
                <tr>
                    <td class="red-header">MOTIVO DE LA SOLICITUD:</td>
                </tr>
                <tr>
                    <td style="height: 25mm; padding: 2mm;">
                        <textarea class="lined-area" rows="5"></textarea>
                    </td>
                </tr>
            </table>

            <!-- DIAGN√ìSTICO DEL EQUIPO -->
            <table>
                <tr>
                    <td class="red-header">DIAGN√ìSTICO DEL EQUIPO:</td>
                </tr>
                <tr>
                    <td style="height: 25mm; padding: 2mm;">
                        <textarea class="lined-area" rows="5"></textarea>
                    </td>
                </tr>
            </table>

            <!-- ACCIONES REALIZADAS -->
            <table>
                <tr>
                    <td class="red-header">ACCIONES REALIZADAS:</td>
                </tr>
                <tr>
                    <td style="height: 35mm; padding: 2mm;">
                        <textarea class="lined-area" rows="7"></textarea>
                    </td>
                </tr>
            </table>

            <!-- COMPONENTES AFECTADOS -->
            <table>
                <tr>
                    <td class="red-header" colspan="7">
                        COMPONENTES AFECTADOS
                        <span style="float: right;">
                            <span class="checkbox-container">
                                <input type="checkbox" id="trabajoRealizado">
                                <label class="checkbox-label" for="trabajoRealizado">Trabajo realizado</label>
                            </span>
                            <span class="checkbox-container">
                                <input type="checkbox" id="presupuesto">
                                <label class="checkbox-label" for="presupuesto">Presupuesto</label>
                            </span>
                        </span>
                    </td>
                </tr>
                <tr>
                    <th class="col-num">#</th>
                    <th class="col-cant">Cant</th>
                    <th class="col-codigo">C√≥digo</th>
                    <th class="col-componente">Componente</th>
                    <th class="col-defecto">Defecto</th>
                    <th class="col-check">Reparar</th>
                    <th class="col-check">Reemplazar/Costo</th>
                </tr>
                <tr>
                    <td class="col-num">1</td>
                    <td class="col-cant"><input type="text"></td>
                    <td class="col-codigo"><input type="text"></td>
                    <td class="col-componente"><input type="text"></td>
                    <td class="col-defecto"><input type="text"></td>
                    <td class="col-check">
                        <span class="checkbox-container" style="justify-content: center; margin: 0;">
                            <input type="checkbox" id="rep1">
                            <label class="checkbox-label" for="rep1">SI</label>
                        </span>
                    </td>
                    <td class="col-check">
                        <span class="checkbox-container" style="justify-content: center; margin: 0;">
                            <input type="checkbox" id="remp1">
                            <label class="checkbox-label" for="remp1">SI</label>
                        </span>
                    </td>
                </tr>
                <tr>
                    <td class="col-num">2</td>
                    <td class="col-cant"><input type="text"></td>
                    <td class="col-codigo"><input type="text"></td>
                    <td class="col-componente"><input type="text"></td>
                    <td class="col-defecto"><input type="text"></td>
                    <td class="col-check">
                        <span class="checkbox-container" style="justify-content: center; margin: 0;">
                            <input type="checkbox" id="rep2">
                            <label class="checkbox-label" for="rep2">SI</label>
                        </span>
                    </td>
                    <td class="col-check">
                        <span class="checkbox-container" style="justify-content: center; margin: 0;">
                            <input type="checkbox" id="remp2">
                            <label class="checkbox-label" for="remp2">SI</label>
                        </span>
                    </td>
                </tr>
                <tr>
                    <td class="col-num">3</td>
                    <td class="col-cant"><input type="text"></td>
                    <td class="col-codigo"><input type="text"></td>
                    <td class="col-componente"><input type="text"></td>
                    <td class="col-defecto"><input type="text"></td>
                    <td class="col-check">
                        <span class="checkbox-container" style="justify-content: center; margin: 0;">
                            <input type="checkbox" id="rep3">
                            <label class="checkbox-label" for="rep3">SI</label>
                        </span>
                    </td>
                    <td class="col-check">
                        <span class="checkbox-container" style="justify-content: center; margin: 0;">
                            <input type="checkbox" id="remp3">
                            <label class="checkbox-label" for="remp3">SI</label>
                        </span>
                    </td>
                </tr>
                <tr>
                    <td class="col-num">4</td>
                    <td class="col-cant"><input type="text"></td>
                    <td class="col-codigo"><input type="text"></td>
                    <td class="col-componente"><input type="text"></td>
                    <td class="col-defecto"><input type="text"></td>
                    <td class="col-check">
                        <span class="checkbox-container" style="justify-content: center; margin: 0;">
                            <input type="checkbox" id="rep4">
                            <label class="checkbox-label" for="rep4">SI</label>
                        </span>
                    </td>
                    <td class="col-check">
                        <span class="checkbox-container" style="justify-content: center; margin: 0;">
                            <input type="checkbox" id="remp4">
                            <label class="checkbox-label" for="remp4">SI</label>
                        </span>
                    </td>
                </tr>
            </table>

            <!-- MO REPARACI√ìN -->
            <table>
                <tr>
                    <td class="red-header" style="width: 25%;">MO REPARACI√ìN:</td>
                    <td><input type="text"></td>
                </tr>
            </table>

            <!-- COMENTARIOS CLIENTE -->
            <table>
                <tr>
                    <td class="red-header">COMENTARIOS CLIENTE:</td>
                </tr>
                <tr>
                    <td style="height: 25mm; padding: 2mm;">
                        <textarea class="lined-area" rows="5"></textarea>
                    </td>
                </tr>
            </table>

            <!-- Signatures -->
            <table style="margin-top: 5mm;">
                <tr>
                    <td style="width: 50%; padding: 3mm; vertical-align: top;">
                        <canvas id="tecnicoCanvas" class="signature-canvas" width="340" height="120"></canvas>
                        <div class="signature-label">T√âCNICO: Firma y aclaraci√≥n</div>
                        <button class="clear-btn" onclick="clearSignature('tecnico')">Limpiar firma</button>
                    </td>
                    <td style="width: 50%; padding: 3mm; vertical-align: top;">
                        <canvas id="clienteCanvas" class="signature-canvas" width="340" height="120"></canvas>
                        <div class="signature-label">CLIENTE: Firma, aclaraci√≥n y DNI</div>
                        <button class="clear-btn" onclick="clearSignature('cliente')">Limpiar firma</button>
                    </td>
                </tr>
            </table>

            <!-- Footer -->
            <div class="footer">
                La garant√≠a del producto se limita a defectos de fabricaci√≥n. Fallas derivadas por mal uso o incorrecta instalaci√≥n anulan la garant√≠a (<em>ver con su instalador</em>). Ver detalle en el manual correspondiente al equipo: www.peisa.com.ar/chequeo-en-el-hogar/manuales/<br>
                La reparaci√≥n tiene garant√≠a de 6 meses que cubre mano de obra y repuestos utilizados (<em>√∫nicamente</em>). Los presupuestos tienen una validez de 15 d√≠as m√°ximo.<br>
                En caso de exceder plazo desde fecha factura de compra y/o que no se cumplan condiciones de la garant√≠a, se deber√° abonar el cargo correspondiente al servicio.
            </div>
        </div>
    </div>

    <!-- Controls at bottom -->
    <div class="controls" style="margin-top: 20px;">
        <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="loadImage(event)">
        <button onclick="document.getElementById('imageUpload').click()" style="padding: 10px 20px; background: #2196F3; color: white; border: none; cursor: pointer; border-radius: 4px; font-size: 14px; margin-right: 10px;">
            üì∑ Agregar Foto del Equipo
        </button>
        <button class="btn-save" onclick="savePDF()">üíæ Guardar como PDF</button>
    </div>

    <script>
        // Image upload and drag functionality
        let currentImageSize = 1;
        
        function loadImage(event) {
            const container = document.getElementById('imageContainer');
            const image = document.getElementById('uploadedImage');
            
            image.src = URL.createObjectURL(event.target.files[0]);
            container.style.display = 'block';
            
            // Position image at top center initially
            container.style.left = '50%';
            container.style.top = '20px';
            container.style.transform = 'translateX(-50%)';
            
            currentImageSize = 1;
        }
        
        function removeImage() {
            const container = document.getElementById('imageContainer');
            const image = document.getElementById('uploadedImage');
            const fileInput = document.getElementById('imageUpload');
            
            image.src = '';
            container.style.display = 'none';
            fileInput.value = '';
            currentImageSize = 1;
        }
        
        function resizeImage(direction) {
            const image = document.getElementById('uploadedImage');
            
            if (direction === 'larger' && currentImageSize < 2) {
                currentImageSize += 0.2;
            } else if (direction === 'smaller' && currentImageSize > 0.4) {
                currentImageSize -= 0.2;
            }
            
            const baseWidth = 300;
            const baseHeight = 200;
            image.style.maxWidth = (baseWidth * currentImageSize) + 'px';
            image.style.maxHeight = (baseHeight * currentImageSize) + 'px';
        }
        
        // Make image draggable
        const imageContainer = document.getElementById('imageContainer');
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;
        
        imageContainer.addEventListener('mousedown', dragStart);
        imageContainer.addEventListener('touchstart', dragStart);
        
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag);
        
        document.addEventListener('mouseup', dragEnd);
        document.addEventListener('touchend', dragEnd);
        
        function dragStart(e) {
            // Don't drag if clicking on buttons
            if (e.target.tagName === 'BUTTON') {
                return;
            }
            
            if (e.type === 'touchstart') {
                initialX = e.touches[0].clientX - xOffset;
                initialY = e.touches[0].clientY - yOffset;
            } else {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
            }
            
            if (e.target === imageContainer || e.target === document.getElementById('uploadedImage')) {
                isDragging = true;
            }
        }
        
        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                
                if (e.type === 'touchmove') {
                    currentX = e.touches[0].clientX - initialX;
                    currentY = e.touches[0].clientY - initialY;
                } else {
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                }
                
                xOffset = currentX;
                yOffset = currentY;
                
                setTranslate(currentX, currentY, imageContainer);
            }
        }
        
        function setTranslate(xPos, yPos, el) {
            el.style.transform = `translate(${xPos}px, ${yPos}px)`;
            el.style.left = '0';
            el.style.top = '0';
        }
        
        function dragEnd() {
            initialX = currentX;
            initialY = currentY;
            isDragging = false;
        }
        
        // Signature functionality
        const canvases = {
            tecnico: document.getElementById('tecnicoCanvas'),
            cliente: document.getElementById('clienteCanvas')
        };
        
        const contexts = {
            tecnico: canvases.tecnico.getContext('2d'),
            cliente: canvases.cliente.getContext('2d')
        };
        
        let isDrawing = {
            tecnico: false,
            cliente: false
        };
        
        function setupCanvas(type) {
            const canvas = canvases[type];
            const ctx = contexts[type];
            
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            let lastX = 0;
            let lastY = 0;
            
            function getCoordinates(e) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                
                if (e.touches) {
                    return {
                        x: (e.touches[0].clientX - rect.left) * scaleX,
                        y: (e.touches[0].clientY - rect.top) * scaleY
                    };
                }
                return {
                    x: (e.clientX - rect.left) * scaleX,
                    y: (e.clientY - rect.top) * scaleY
                };
            }
            
            function startDrawing(e) {
                isDrawing[type] = true;
                const coords = getCoordinates(e);
                lastX = coords.x;
                lastY = coords.y;
                e.preventDefault();
            }
            
            function draw(e) {
                if (!isDrawing[type]) return;
                
                const coords = getCoordinates(e);
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(coords.x, coords.y);
                ctx.stroke();
                
                lastX = coords.x;
                lastY = coords.y;
                e.preventDefault();
            }
            
            function stopDrawing() {
                isDrawing[type] = false;
            }
            
            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
        }
        
        setupCanvas('tecnico');
        setupCanvas('cliente');
        
        function clearSignature(type) {
            const canvas = canvases[type];
            const ctx = contexts[type];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        async function savePDF() {
            const { jsPDF } = window.jspdf;
            
            // Hide interactive buttons during PDF generation
            const clearBtns = document.querySelectorAll('.clear-btn');
            const imageContainer = document.getElementById('imageContainer');
            const imageButtons = imageContainer.querySelectorAll('button');
            const controlsDiv = document.querySelector('.controls');
            
            clearBtns.forEach(btn => btn.style.visibility = 'hidden');
            imageButtons.forEach(btn => btn.style.visibility = 'hidden');
            
            // Remove border from image container
            const originalBorder = imageContainer.style.border;
            imageContainer.style.border = 'none';
            
            // Hide controls
            if (controlsDiv) controlsDiv.style.display = 'none';
            
            // Show loading message
            const saveBtn = document.querySelector('.btn-save');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '‚è≥ Generando PDF...';
            saveBtn.disabled = true;
            
            // Store original inputs and textareas
            const inputs = document.querySelectorAll('#formContent input[type="text"]');
            const textareas = document.querySelectorAll('#formContent textarea');
            const checkboxes = document.querySelectorAll('#formContent input[type="checkbox"]');
            
            const originalElements = [];
            
            try {
                // Replace inputs with divs containing their text
                inputs.forEach(input => {
                    const div = document.createElement('div');
                    div.textContent = input.value;
                    div.style.cssText = 'font-family: Arial, sans-serif; font-size: 11px; line-height: 1.3; word-wrap: break-word; padding: 1mm 0;';
                    originalElements.push({ original: input, replacement: div });
                    input.parentNode.replaceChild(div, input);
                });
                
                // Replace textareas with divs
                textareas.forEach(textarea => {
                    const div = document.createElement('div');
                    div.textContent = textarea.value;
                    div.style.cssText = 'font-family: Arial, sans-serif; font-size: 11px; line-height: 5mm; word-wrap: break-word; white-space: pre-wrap;';
                    originalElements.push({ original: textarea, replacement: div });
                    textarea.parentNode.replaceChild(div, textarea);
                });
                
                // Replace checkboxes with symbols
                checkboxes.forEach(checkbox => {
                    const span = document.createElement('span');
                    span.textContent = checkbox.checked ? '‚òë' : '‚òê';
                    span.style.cssText = 'font-size: 14px;';
                    originalElements.push({ original: checkbox, replacement: span });
                    checkbox.parentNode.replaceChild(span, checkbox);
                });
                
                // Wait for DOM to update
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const element = document.querySelector('.page-container');
                
                // Capture with html2canvas
                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    width: element.offsetWidth,
                    height: element.offsetHeight
                });
                
                const imgData = canvas.toDataURL('image/png', 1.0);
                
                // Create PDF with proper aspect ratio
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Calculate dimensions to maintain aspect ratio
                const pdfWidth = 210;
                const pdfHeight = 297;
                const margin = 10;
                const maxWidth = pdfWidth - (margin * 2);
                const maxHeight = pdfHeight - (margin * 2);
                
                // Get canvas aspect ratio
                const canvasAspectRatio = canvas.width / canvas.height;
                const maxAspectRatio = maxWidth / maxHeight;
                
                let finalWidth, finalHeight;
                
                if (canvasAspectRatio > maxAspectRatio) {
                    // Canvas is wider - fit to width
                    finalWidth = maxWidth;
                    finalHeight = maxWidth / canvasAspectRatio;
                } else {
                    // Canvas is taller - fit to height
                    finalHeight = maxHeight;
                    finalWidth = maxHeight * canvasAspectRatio;
                }
                
                // Center on page
                const xOffset = (pdfWidth - finalWidth) / 2;
                const yOffset = (pdfHeight - finalHeight) / 2;
                
                pdf.addImage(imgData, 'PNG', xOffset, yOffset, finalWidth, finalHeight);
                
                // Save the PDF
                const date = new Date().toISOString().split('T')[0];
                pdf.save(`PEISA_Formulario_${date}.pdf`);
                
                saveBtn.innerHTML = '‚úì PDF Guardado';
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error al generar el PDF. Por favor intente nuevamente.');
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            } finally {
                // Restore original elements
                originalElements.forEach(({ original, replacement }) => {
                    replacement.parentNode.replaceChild(original, replacement);
                });
                
                // Restore buttons and border
                clearBtns.forEach(btn => btn.style.visibility = 'visible');
                imageButtons.forEach(btn => btn.style.visibility = 'visible');
                imageContainer.style.border = originalBorder;
                if (controlsDiv) controlsDiv.style.display = 'block';
            }
        }
    </script>
</body>
</html>
